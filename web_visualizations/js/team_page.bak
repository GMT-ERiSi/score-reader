// team_page.js - Load and display team-specific data
console.log('Team page script loading...');

// Import our modular components
try {
    const moduleStart = performance.now();
    console.log('Importing modules...');

    // Dynamic imports
    async function loadModules() {
        try {
            console.log('Loading tableInteractivity.js...');
            const tableInteractivity = await import('./tableInteractivity.js');
            const { makeTableSortable, addTableFilter, enableTableRowSelection, addRoleFilter, filterTableByRole } = tableInteractivity;
            console.log('tableInteractivity.js loaded successfully');

            console.log('Loading chartInteractivity.js...');
            const chartInteractivity = await import('./chartInteractivity.js');
            const { enhanceChartInteractivity, filterChartByName, addChartControls } = chartInteractivity;
            console.log('chartInteractivity.js loaded successfully');

            console.log('Loading leaderboardManager.js...');
            const leaderboardManager = await import('./leaderboardManager.js');
            const { createAdditionalLeaderboards } = leaderboardManager;
            console.log('leaderboardManager.js loaded successfully');

            console.log('Loading realdata_fixed.js...');
            const realData = await import('./realdata_fixed.js');
            const { loadAllRealData } = realData;
            console.log('realdata_fixed.js loaded successfully');

            const moduleEnd = performance.now();
            console.log(`All modules loaded in ${(moduleEnd - moduleStart).toFixed(2)}ms`);

            // Now that modules are loaded, initialize the app
            initializeApp({
                makeTableSortable, 
                addTableFilter, 
                enableTableRowSelection,
                enhanceChartInteractivity,
                filterChartByName,
                addChartControls,
                createAdditionalLeaderboards,
                loadAllRealData,
                addRoleFilter,
                filterTableByRole
            });

        } catch (error) {
            console.error('Error loading modules:', error);
            document.body.innerHTML += `<div style="color: red; padding: 20px; margin: 20px; border: 1px solid red; background: #ffeeee;">
                <h2>Error Loading Visualization</h2>
                <p>There was an error loading the visualization components. Please check the console for details.</p>
                <p>Error: ${error.message}</p>
            </div>`;
        }
    }

    // Start loading modules
    loadModules();

} catch (error) {
    console.error('Critical error in team_page.js:', error);
}

// Initialize application with imported modules
function initializeApp(modules) {
    console.log('Initializing team page application...');
    
    const {
        makeTableSortable, 
        addTableFilter, 
        enableTableRowSelection,
        enhanceChartInteractivity,
        filterChartByName,
        addChartControls,
        createAdditionalLeaderboards,
        loadAllRealData,
        addRoleFilter,
        filterTableByRole
    } = modules;

    // Data storage
    let teamEloHistory = [];
    let teamEloLadder = [];
    let playerStats = []; // For additional leaderboards

    // Chart instances
    let teamEloChartInstance = null;

    // DOM Elements
    const teamEloChartCtx = document.getElementById('teamEloChart')?.getContext('2d');
    const teamEloTableBody = document.getElementById('teamEloTable')?.querySelector('tbody');

    // --- Rendering Functions ---
    function renderTeamEloChart() {
        console.log("Rendering Team ELO Chart...");
        if (!teamEloChartCtx || !teamEloHistory || teamEloHistory.length === 0) {
            console.warn("Team ELO Chart context or data not available.");
            const chartContainer = document.getElementById('teamEloChart')?.parentElement;
            if (chartContainer && !chartContainer.querySelector('.no-data-message')) {
                const msg = document.createElement('p');
                msg.textContent = 'Team ELO history data not available or chart canvas not found.';
                msg.className = 'no-data-message';
                chartContainer.appendChild(msg);
            }
            return;
        }

        // Process data for Chart.js
        const teamsData = {}; // { team_id: { name: 'Team Name', data: [{x: date, y: rating}] } }
        const allDates = new Set();

        teamEloHistory.forEach(match => {
            // Try to parse the date
            let matchTimestamp;
            try {
                matchTimestamp = new Date(match.match_date.replace(' ', 'T')).getTime();
                
                if (isNaN(matchTimestamp)) {
                    // Try alternative date formats if needed
                    const dateParts = match.match_date.split(/[\s-:]/);
                    if (dateParts.length >= 3) {
                        const correctedDate = `${dateParts[0]}-${dateParts[2]}-${dateParts[1]} ${dateParts[3] || '12'}:${dateParts[4] || '00'}:${dateParts[5] || '00'}`;
                        matchTimestamp = new Date(correctedDate.replace(' ', 'T')).getTime();
                    }
                }
            } catch (e) {
                console.warn(`Error parsing date: ${e.message}`);
                matchTimestamp = NaN;
            }
            
            if (isNaN(matchTimestamp)) {
                console.warn(`Invalid date format found in team history: ${match.match_date} for match ID ${match.match_id}`);
                return; // Skip this match entry if date is invalid
            }
            
            allDates.add(matchTimestamp); // Use the timestamp

            // Process Imperial team
            if (!teamsData[match.imperial.team_id]) {
                teamsData[match.imperial.team_id] = { name: match.imperial.team_name, data: [] };
            }
            // Add rating points
            teamsData[match.imperial.team_id].data.push({ x: matchTimestamp, y: match.imperial.old_rating });
            teamsData[match.imperial.team_id].data.push({ x: matchTimestamp, y: match.imperial.new_rating });

            // Process Rebel team
            if (!teamsData[match.rebel.team_id]) {
                teamsData[match.rebel.team_id] = { name: match.rebel.team_name, data: [] };
            }
            // Add rating points
            teamsData[match.rebel.team_id].data.push({ x: matchTimestamp, y: match.rebel.old_rating });
            teamsData[match.rebel.team_id].data.push({ x: matchTimestamp, y: match.rebel.new_rating });
        });

        // Sort data points by date for each team
        for (const teamId in teamsData) {
            teamsData[teamId].data.sort((a, b) => a.x - b.x);
        }

        // Generate datasets for Chart.js
        const datasets = Object.values(teamsData).map(team => ({
            label: team.name,
            data: team.data,
            fill: false,
            borderColor: getRandomColor(), // Function to generate random colors
            tension: 0.1,
            pointRadius: 2,
            pointHoverRadius: 5
        }));

        // Destroy previous chart instance if it exists
        if (teamEloChartInstance) {
            teamEloChartInstance.destroy();
        }

        // Create the chart
        teamEloChartInstance = new Chart(teamEloChartCtx, {
            type: 'line',
            data: {
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            tooltipFormat: 'PPP p',
                            displayFormats: {
                                day: 'MMM d, yyyy'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Match Date'
                        },
                        ticks: {
                            autoSkip: true,
                            maxTicksLimit: 15
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'ELO Rating'
                        },
                        beginAtZero: false // ELO doesn't start at 0
                    }
                },
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            boxWidth: 12,
                            padding: 15
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
        
        // Apply enhanced chart interactivity
        enhanceChartInteractivity(teamEloChartInstance);
        addChartControls('teamEloChart');
        
        console.log("Team ELO Chart rendered.");
    }

    // Helper function to generate random colors for chart lines
    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }

    function renderTeamEloTable() {
        console.log("Rendering Team ELO Table...");
        if (!teamEloTableBody || !teamEloLadder || teamEloLadder.length === 0) {
            console.warn("Team ELO table body or data not available.");
            const table = document.getElementById('teamEloTable');
            if (table && !table.querySelector('.no-data-message')) {
                const msgRow = table.insertRow();
                const cell = msgRow.insertCell();
                cell.colSpan = 5; // Span across all columns
                cell.textContent = 'Team ELO ladder data not available.';
                cell.className = 'no-data-message';
                cell.style.textAlign = 'center';
            }
            return;
        }
        // Clear previous data
        teamEloTableBody.innerHTML = '';

        // Ensure ladder is sorted by rank (it should be already, but just in case)
        const sortedLadder = teamEloLadder.sort((a, b) => a.rank - b.rank);

        // Check if we should add a role column
        const table = document.getElementById('teamEloTable');
        const headerRow = table.querySelector('thead tr');
        let hasRoleColumn = false;
        
        // Look for "Role" in the header
        headerRow.querySelectorAll('th').forEach(th => {
            if (th.textContent.toLowerCase().includes('role')) {
                hasRoleColumn = true;
            }
        });
        
        // Add role column if it doesn't exist and we have player roles
        if (!hasRoleColumn && playerStats.some(p => p.role)) {
            console.log("Adding Role column to team table");
            const roleHeader = document.createElement('th');
            roleHeader.textContent = 'Primary Roles';
            // Insert after team name column
            const nameHeader = headerRow.querySelector('th:nth-child(2)');
            if (nameHeader) {
                headerRow.insertBefore(roleHeader, nameHeader.nextSibling);
            } else {
                headerRow.appendChild(roleHeader);
            }
        }

        // Populate table rows
        sortedLadder.forEach(team => {
            const row = teamEloTableBody.insertRow();

            const rankCell = row.insertCell();
            rankCell.textContent = team.rank;
            rankCell.classList.add('rank-cell');

            const nameCell = row.insertCell();
            nameCell.textContent = team.team_name;
            
            // Add role cell if we added the header
            if (!hasRoleColumn && playerStats.some(p => p.role)) {
                const roleCell = row.insertCell();
                
                // Get roles for this team's players
                const teamRoles = getTeamRoles(team.team_name, team.team_id);
                roleCell.textContent = teamRoles || 'N/A';
                roleCell.classList.add('role-cell');
                
                // Store role data for filtering
                if (teamRoles) {
                    row.dataset.roles = teamRoles;
                }
            }

            const eloCell = row.insertCell();
            eloCell.textContent = team.elo_rating;

            const wlCell = row.insertCell();
            wlCell.textContent = `${team.matches_won}-${team.matches_lost}`;

            const winRateCell = row.insertCell();
            winRateCell.textContent = `${team.win_rate}%`;
        });
        console.log("Team ELO Table populated.");
    }
    
    // Helper function to get roles for a team
    function getTeamRoles(teamName, teamId) {
        // Find players with this team as their primary team
        const teamPlayers = playerStats.filter(player => {
            // Check if this player is associated with this team
            return player.team_name === teamName || player.team_id === teamId;
        });
        
        if (teamPlayers.length === 0) {
            return null;
        }
        
        // Count roles
        const roleCounts = {};
        teamPlayers.forEach(player => {
            if (player.role) {
                roleCounts[player.role] = (roleCounts[player.role] || 0) + 1;
            }
        });
        
        // Format role counts as "Flex (3), Support (2), Farmer (1)"
        const roleTexts = Object.entries(roleCounts)
            .sort((a, b) => b[1] - a[1]) // Sort by count descending
            .map(([role, count]) => `${role} (${count})`)
            .join(', ');
            
        return roleTexts || null;
    }

    // Function to apply interactive features to tables
    function applyTableInteractivity() {
        console.log("Applying table interactivity features...");
        
        // Make team ELO table sortable
        makeTableSortable('teamEloTable');
        addTableFilter('teamEloTable', 'Search teams...');
        enableTableRowSelection('teamEloTable', (teamName) => {
            filterChartByName(teamEloChartInstance, teamName);
        });
        
        // Add button event listener for showing all teams
        const showAllButton = document.getElementById('showAllTeamsButton');
        if (showAllButton) {
            showAllButton.addEventListener('click', () => {
                filterChartByName(teamEloChartInstance, null); // Clear filters
                
                // Clear any selected rows
                const selectedRows = document.querySelectorAll('#teamEloTable tbody tr.selected');
                selectedRows.forEach(row => row.classList.remove('selected'));
            });
        }
        
        // Add role filter for team page
        const roleFilterContainer = document.getElementById('teamRoleFilterContainer');
        if (roleFilterContainer) {
            // Force visibility and styling
            roleFilterContainer.style.display = 'flex';
            roleFilterContainer.style.flexWrap = 'wrap';
            roleFilterContainer.style.gap = '8px';
            roleFilterContainer.style.padding = '10px';
            roleFilterContainer.style.border = '2px solid #0066cc';
            roleFilterContainer.style.backgroundColor = '#f8f8f8';
            roleFilterContainer.style.margin = '15px 0';
            
            // Add a clear message if addRoleFilter is not defined
            if (typeof addRoleFilter !== 'function') {
                console.error("addRoleFilter function is not defined!");
                roleFilterContainer.innerHTML = '<div style="color: red; font-weight: bold;">Error: Role filtering function not available</div>';
            } else {
                // Extract unique roles from player stats
                const uniqueRoles = new Set();
                playerStats.forEach(player => {
                    if (player.role) {
                        uniqueRoles.add(player.role);
                    }
                });
                
                console.log(`Found ${uniqueRoles.size} unique roles for team players:`, Array.from(uniqueRoles));
                
                if (uniqueRoles.size > 0) {
                    // Add role filter using the roles we found
                    console.log("Adding role filter buttons for team page");
                    addRoleFilter('teamEloTable', Array.from(uniqueRoles), 'teamRoleFilterContainer');
                } else {
                    // Add default roles if none found
                    console.log("No roles found, adding default role buttons");
                    addRoleFilter('teamEloTable', ['Farmer', 'Flex', 'Support'], 'teamRoleFilterContainer');
                }
            }
        }
        
        console.log("Table interactivity features applied.");
    }

    async function renderVisualizations() {
        try {
            console.log("Starting team visualization rendering...");

            // Call individual rendering functions
            renderTeamEloChart();
            renderTeamEloTable();
            
            // Apply interactivity
            try {
                applyTableInteractivity();
            } catch (err) {
                console.error("Error applying table interactivity:", err);
                
                // Fallback: Add direct role filter buttons if the module import failed
                createDirectRoleFilter();
            }
            
            await createAdditionalLeaderboards('#leaderboards-container', playerStats);
            
            console.log("All team visualizations rendered successfully");
        } catch (error) {
            console.error("Error rendering team visualizations:", error);
            document.body.innerHTML += `<div style="color: red; padding: 20px; margin: 20px; border: 1px solid red; background: #ffeeee;">
                <h2>Error Rendering Visualizations</h2>
                <p>There was an error rendering the visualizations. Please check the console for details.</p>
                <p>Error: ${error.message}</p>
            </div>`;
        }
    }
    
    // Fallback function to create role filter buttons directly
    function createDirectRoleFilter() {
        console.log("Creating direct role filter buttons as fallback");
        
        const roleFilterContainer = document.getElementById('teamRoleFilterContainer');
        if (!roleFilterContainer) return;
        
        // Clear any existing content
        roleFilterContainer.innerHTML = '';
        
        // Style the container
        roleFilterContainer.style.display = 'block';
        roleFilterContainer.style.border = '2px solid #0066cc';
        roleFilterContainer.style.padding = '15px';
        roleFilterContainer.style.margin = '15px 0';
        roleFilterContainer.style.backgroundColor = '#f0f8ff';
        roleFilterContainer.style.borderRadius = '8px';
        
        // Add heading
        const heading = document.createElement('h4');
        heading.textContent = 'Filter by Player Role';
        heading.style.marginTop = '0';
        heading.style.marginBottom = '10px';
        heading.style.color = '#333';
        roleFilterContainer.appendChild(heading);
        
        // Extract roles from player stats
        const uniqueRoles = new Set();
        
        // Add default roles in case none are found
        const defaultRoles = ['Farmer', 'Flex', 'Support'];
        
        playerStats.forEach(player => {
            if (player.role) {
                uniqueRoles.add(player.role);
            }
        });
        
        // If no roles found, use default roles
        const rolesToUse = uniqueRoles.size > 0 ? Array.from(uniqueRoles) : defaultRoles;
        
        // Create buttons container
        const buttonContainer = document.createElement('div');
        buttonContainer.style.display = 'flex';
        buttonContainer.style.flexWrap = 'wrap';
        buttonContainer.style.gap = '8px';
        roleFilterContainer.appendChild(buttonContainer);
        
        // Add "All" button
        const allButton = document.createElement('button');
        allButton.textContent = 'All Roles';
        allButton.className = 'role-filter-button active';
        allButton.style.padding = '8px 15px';
        allButton.style.margin = '4px';
        allButton.style.backgroundColor = '#0066cc';
        allButton.style.color = 'white';
        allButton.style.fontWeight = 'bold';
        allButton.style.border = '1px solid #0055aa';
        allButton.style.borderRadius = '4px';
        allButton.style.cursor = 'pointer';
        allButton.dataset.role = 'all';
        buttonContainer.appendChild(allButton);
        
        // Function to filter the table by role
        const directFilterByRole = (role) => {
            const table = document.getElementById('teamEloTable');
            if (!table) return;
            
            const rows = table.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                // Check if row has role information
                if (role === 'all') {
                    row.style.display = '';
                    return;
                }
                
                // For "No Role", show only rows without roles
                if (role === 'none') {
                    const roles = row.dataset.roles;
                    if (!roles || roles.trim() === '') {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                    return;
                }
                
                // For specific role, check if it's included
                const roles = row.dataset.roles || '';
                if (roles.toLowerCase().includes(role.toLowerCase())) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };
        
        // Add role buttons
        rolesToUse.forEach(role => {
            const button = document.createElement('button');
            button.textContent = role;
            button.className = 'role-filter-button';
            button.style.padding = '8px 15px';
            button.style.margin = '4px';
            button.style.backgroundColor = '#f2f2f2';
            button.style.border = '1px solid #ddd';
            button.style.borderRadius = '4px';
            button.style.cursor = 'pointer';
            button.style.fontWeight = 'bold';
            button.dataset.role = role;
            
            // Add click handler
            button.addEventListener('click', () => {
                // Update button styling
                buttonContainer.querySelectorAll('.role-filter-button').forEach(btn => {
                    btn.classList.remove('active');
                    btn.style.backgroundColor = '#f2f2f2';
                    btn.style.color = '#333';
                });
                
                button.classList.add('active');
                button.style.backgroundColor = '#0066cc';
                button.style.color = 'white';
                
                // Filter the table
                directFilterByRole(role);
            });
            
            buttonContainer.appendChild(button);
        });
        
        // Add "None" button
        const noneButton = document.createElement('button');
        noneButton.textContent = 'No Role';
        noneButton.className = 'role-filter-button';
        noneButton.style.padding = '8px 15px';
        noneButton.style.margin = '4px';
        noneButton.style.backgroundColor = '#f2f2f2';
        noneButton.style.border = '1px solid #ddd';
        noneButton.style.borderRadius = '4px';
        noneButton.style.cursor = 'pointer';
        noneButton.style.fontWeight = 'bold';
        noneButton.dataset.role = 'none';
        
        // Add click handler for None button
        noneButton.addEventListener('click', () => {
            // Update button styling
            buttonContainer.querySelectorAll('.role-filter-button').forEach(btn => {
                btn.classList.remove('active');
                btn.style.backgroundColor = '#f2f2f2';
                btn.style.color = '#333';
            });
            
            noneButton.classList.add('active');
            noneButton.style.backgroundColor = '#0066cc';
            noneButton.style.color = 'white';
            
            // Filter the table
            directFilterByRole('none');
        });
        
        buttonContainer.appendChild(noneButton);
        
        // Add click handler for All button
        allButton.addEventListener('click', () => {
            // Update button styling
            buttonContainer.querySelectorAll('.role-filter-button').forEach(btn => {
                btn.classList.remove('active');
                btn.style.backgroundColor = '#f2f2f2';
                btn.style.color = '#333';
            });
            
            allButton.classList.add('active');
            allButton.style.backgroundColor = '#0066cc';
            allButton.style.color = 'white';
            
            // Filter the table
            directFilterByRole('all');
        });
        
        console.log("Direct role filter buttons created");
    }

    // Initialize data and render
    async function initializeData() {
        try {
            console.log("Initializing team data...");
            
            // Set global flag to indicate team page
            window.isTeamPage = true;
            
            // Load real data
            const data = await loadAllRealData();
            
            // Validate that we have team data
            if (!data.teamEloLadder || data.teamEloLadder.length === 0) {
                console.error("No team ladder data loaded!");
                document.body.innerHTML += `
                    <div style="color: red; padding: 20px; margin: 20px; border: 1px solid red; background: #ffeeee;">
                        <h2>Team Data Not Found</h2>
                        <p>Could not load team ELO ladder data. Please ensure that team data has been generated.</p>
                        <p>Expected file: ../stats_reports/elo_ladder_team.json</p>
                    </div>
                `;
            }
            
            // Store data for use in rendering
            teamEloHistory = data.teamEloHistory;
            teamEloLadder = data.teamEloLadder;
            
            // Filter player stats to only include team-related stats
            // This ensures we don't show pickup player stats in team leaderboards
            if (data.playerStats && data.playerStats.length > 0) {
                // Only keep player stats for team matches
                const teamPlayerNames = new Set();
                
                // Get all player names from team ladder
                if (teamEloLadder && teamEloLadder.length > 0) {
                    // Extract team info if available
                    const teamNames = new Set(teamEloLadder.map(t => t.team_name));
                    console.log("Team names in ladder:", Array.from(teamNames));
                }
                
                playerStats = data.playerStats;
                console.log(`Loaded ${playerStats.length} player stats entries`);
            } else {
                playerStats = [];
                console.log("No player stats data available for teams");
            }
            
            console.log("Team data loaded successfully");
            console.log("Team ladder entries:", teamEloLadder.length);
            console.log("Team history entries:", teamEloHistory.length);
            
            // Render visualizations
            await renderVisualizations();
            
            console.log("Team page initialization complete");
        } catch (error) {
            console.error("Error initializing team data:", error);
            document.body.innerHTML += `
                <div style="color: red; padding: 20px; margin: 20px; border: 1px solid red; background: #ffeeee;">
                    <h2>Error Loading Team Data</h2>
                    <p>There was an error initializing the team data: ${error.message}</p>
                </div>
            `;
        }
    }

    // Start initialization
    initializeData();
}