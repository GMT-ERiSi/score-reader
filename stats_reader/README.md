# Stats Reader for Star Wars Squadrons

This module processes Star Wars Squadrons match data into a SQLite database and generates statistics reports.

## Prerequisites

- Python 3.6+
- The JSON data file generated by the `score_extractor.season_processor` module

## Installation

1. Place the `stats_reader` directory in your project folder
2. Ensure you have the required dependencies (standard library only)

## Usage

### Workflow Overview

The recommended workflow is:

1. Set up a reference database of teams and players (optional but recommended)
2. Extract match data from screenshots
3. Clean the extracted data to fix any AI recognition errors
4. Process the cleaned data into the database
5. Generate an ELO ladder and stats reports
6. View the generated reports

### Reference Database Management

The reference database ensures consistent team and player names across all matches:

```bash
python -m stats_reader reference
```

This interactive tool allows you to:
1. Add and manage canonical team names
2. Add and manage canonical player names and their team affiliations
3. Add aliases for teams and players to help match variations
4. Import/export the reference data to JSON files

When processing matches, the system will automatically:
- Match detected player names to their canonical forms
- Suggest team names based on recognized players
- Maintain consistent identities even with spelling variations

### Data Cleaning

Before processing the data, verify and clean it using the data cleaner:

```bash
python -m stats_reader clean --input Screenshots/all_seasons_data.json --output Screenshots/all_seasons_data_cleaned.json
```

This interactive tool will:
1. Display each match one-by-one for review
2. Allow you to edit match results, player names, and stats
3. Save a cleaned version of the data file

### Processing Data

After cleaning, process the data into the database:

```bash
python -m stats_reader process --input Screenshots/all_seasons_data_cleaned.json --reference-db squadrons_reference.db
```

This will:
1. Read the cleaned data file
2. Use the reference database to ensure consistent team/player identification
3. Create a SQLite database (`squadrons_stats.db`)
4. Prompt you for team names for each match (with suggestions based on recognized players)
5. Generate statistics reports in the `stats_reports` directory

### Generating an ELO Ladder

After processing the match data, you can generate an ELO rating ladder for teams:

```bash
python -m stats_reader elo
```

This will:
1. Process all matches in chronological order
2. Calculate ELO ratings for each team based on match results
3. Generate an ELO ladder ranking teams by skill
4. Create reports with the ladder and full ELO history

Options:
- `--starting-elo 1000`: Set the starting ELO rating (default: 1000)
- `--k-factor 32`: Set the K-factor for calculating rating changes (default: 32)
- `--output custom_dir`: Custom output directory for ELO reports

### Finding the Data File

The `all_seasons_data.json` file is typically stored in one of these locations:
- `Screenshots/all_seasons_data.json` (default location)
- `score_extractor/Screenshots/all_seasons_data.json`
- The directory where you ran the season processor

If you're unsure where your file is located, check these locations or search for "all_seasons_data.json" in your project directory.

### Generate Reports Only

If you already have a database and just want to regenerate the reports:

```bash
python -m stats_reader process --generate-only --db path/to/database.db
```

## Database Schema

The SQLite database contains the following tables:

- `seasons`: League/season information
- `teams`: Team names with win/loss records and reference IDs
- `matches`: Individual match records with winner information
- `players`: Player identification with consistent hashing and reference IDs
- `player_stats`: Detailed per-match player statistics

The reference database contains:
- `ref_teams`: Canonical team information with aliases
- `ref_players`: Canonical player information with team affiliations and aliases

## Reports Generated

The module generates the following JSON reports:

1. `team_standings.json`: Win/loss records for all teams
2. `player_performance.json`: Detailed player statistics
3. `faction_win_rates.json`: Win percentages for IMPERIAL vs REBEL
4. `season_summary.json`: Match counts by season
5. `player_teams.json`: History of which players played for which teams
6. `elo_ladder.json`: Team rankings based on ELO ratings
7. `elo_history.json`: Full history of ELO changes for each match

## Understanding ELO Ratings

The ELO rating system provides a way to rank teams based on their relative skill:

- All teams start with 1000 points
- After each match, points are transferred from the loser to the winner
- The amount transferred depends on the expected outcome:
  - When a high-rated team beats a low-rated team, few points are transferred
  - When a low-rated team beats a high-rated team, many points are transferred
- The K-factor (default: 32) determines the maximum possible points transferred

This produces a ranking system that accounts for the quality of opponents faced.

## Reference Database Features

The reference database ensures consistent player and team identification by:

1. **Canonical Names**: Establishing official names for teams and players
2. **Alias Matching**: Handling variations in spelling or formatting
3. **Fuzzy Matching**: Finding the closest match when exact matches aren't found
4. **Team Affiliations**: Tracking which players belong to which teams
5. **Auto-suggestions**: Recommending team names based on recognized players

This system helps maintain consistent statistics even when:
- Player names have typos or variations
- Teams use different abbreviations or formats
- Players move between teams over time

## Example Complete Workflow

1. Set up a reference database (one-time setup):
   ```bash
   python -m stats_reader reference
   ```

2. Extract match data from screenshots:
   ```bash
   python -m score_extractor.season_processor
   ```

3. Clean the extracted data:
   ```bash
   python -m stats_reader clean --input Screenshots/all_seasons_data.json --output Screenshots/all_seasons_data_cleaned.json
   ```

4. Process the cleaned data using the reference database:
   ```bash
   python -m stats_reader process --input Screenshots/all_seasons_data_cleaned.json --reference-db squadrons_reference.db
   ```

5. Generate an ELO ladder:
   ```bash
   python -m stats_reader elo
   ```

6. View the generated reports in the `stats_reports` directory