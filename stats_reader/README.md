# Stats Reader for Star Wars Squadrons

This module processes Star Wars Squadrons match data into a SQLite database and generates statistics reports.

## Prerequisites

- Python 3.6+
- The JSON data file generated by the `score_extractor.season_processor` module

## Installation

1. Place the `stats_reader` directory in your project folder
2. Ensure you have the required dependencies (standard library only)

## Usage

### Workflow Overview

The recommended workflow is:

1. Set up a reference database of teams and players (optional but recommended)
2. Extract match data from screenshots
3. Clean the extracted data to fix any AI recognition errors
4. Process the cleaned data into the database
5. Generate an ELO ladder and stats reports
6. View the generated reports

### Reference Database Management

The reference database ensures consistent team and player names across all matches:

```bash
python -m stats_reader reference
```

This interactive tool allows you to:
1. Add and manage canonical team names
2. Add and manage canonical player names and their team affiliations
3. Add aliases for teams and players to help match variations
4. Import/export the reference data to JSON files

When processing matches, the system will automatically:
- Match detected player names to their canonical forms
- Suggest team names based on recognized players
- Maintain consistent identities even with spelling variations

### Data Cleaning

Before processing the data, verify and clean it using the data cleaner:

```bash
python -m stats_reader clean --input Screenshots/all_seasons_data.json --output Screenshots/all_seasons_data_cleaned.json
```

This interactive tool will:
1. Display each match one-by-one for review
2. Allow you to edit match results, player names, and stats
3. Save a cleaned version of the data file

### Processing Data

After cleaning, process the data into the database:

```bash
python -m stats_reader process --input Screenshots/all_seasons_data_cleaned.json --reference-db squadrons_reference.db
```

This will:
1. Read the cleaned data file
2. Use the reference database (if provided) to ensure consistent team/player identification.
3. Create a SQLite database (`squadrons_stats.db`).
4. Prompt you for team names for each match (with suggestions based on recognized players).
5. **Interactive Player Matching**: If a player name from the data doesn't exactly match a name or alias in the reference database, it will:
    - Display potential fuzzy matches.
    - Prompt you to select a match, add the name as an alias, create a new player, or skip.
    - Cache your decisions during the run to avoid repeated prompts for the same name.
6. Generate statistics reports in the `stats_reports` directory.

### Generating an ELO Ladder

After processing the match data, you can generate an ELO rating ladder for teams:

```bash
python -m stats_reader elo
```

This will:
1. Process all matches in chronological order
2. Calculate ELO ratings for each team based on match results
3. Generate an ELO ladder ranking teams by skill
4. Create reports with the ladder and full ELO history

Options:
- `--starting-elo 1000`: Set the starting ELO rating (default: 1000)
- `--k-factor 32`: Set the K-factor for calculating rating changes (default: 32)
- `--output custom_dir`: Custom output directory for ELO reports

### Finding the Data File

The `all_seasons_data.json` file is typically stored in one of these locations:
- `Screenshots/all_seasons_data.json` (default location)
- `score_extractor/Screenshots/all_seasons_data.json`
- The directory where you ran the season processor

If you're unsure where your file is located, check these locations or search for "all_seasons_data.json" in your project directory.

### Generate Reports Only

If you already have a database and just want to regenerate the reports:

```bash
python -m stats_reader process --generate-only --db path/to/database.db
```

## Database Schema

The SQLite database contains the following tables:

- `seasons`: League/season information
- `teams`: Team names with win/loss records and reference IDs
- `matches`: Individual match records with winner information
- `players`: Player identification with consistent hashing and reference IDs
- `player_stats`: Detailed per-match player statistics with subbing information (is_subbing flag)

The reference database contains:
- `ref_teams`: Canonical team information with aliases
- `ref_players`: Canonical player information with team affiliations and aliases

## Reports Generated

The module generates the following JSON reports:

1. `team_standings.json`: Win/loss records for all teams
2. `player_performance.json`: Detailed player statistics (includes all appearances)
3. `player_performance_no_subs.json`: Player statistics excluding substitute appearances
4. `faction_win_rates.json`: Win percentages for IMPERIAL vs REBEL
5. `season_summary.json`: Match counts by season
6. `player_teams.json`: History of which players played for which teams
7. `subbing_report.json`: Statistics for players' substitute appearances only
8. `elo_ladder.json`: Team rankings based on ELO ratings
9. `elo_history.json`: Full history of ELO changes for each match

## Understanding ELO Ratings

The ELO rating system provides a way to rank teams based on their relative skill:

- All teams start with 1000 points
- After each match, points are transferred from the loser to the winner
- The amount transferred depends on the expected outcome:
  - When a high-rated team beats a low-rated team, few points are transferred
  - When a low-rated team beats a high-rated team, many points are transferred
- The K-factor (default: 32) determines the maximum possible points transferred

This produces a ranking system that accounts for the quality of opponents faced.

## Reference Database Features

The reference database ensures consistent player and team identification by:

1. **Canonical Names**: Establishing official names for teams and players.
2. **Alias Matching**: Handling variations in spelling or formatting via exact alias matching.
3. **Interactive Fuzzy Matching**: When an exact match (name or alias) isn't found during processing, it interactively prompts the user with potential fuzzy matches and options to resolve the ambiguity (select match, add alias, create new, skip).
4. **Team Affiliations**: Tracking which players belong to which teams.
5. **Auto-suggestions**: Recommending team names based on recognized players during processing.

This system helps maintain consistent statistics even when:
- Player names have typos or variations
- Teams use different abbreviations or formats
- Players move between teams over time

## Player Subbing System

The module tracks whether players are appearing for their primary team or acting as substitutes for another team:

### How Subbing Works

1. **Primary Team Assignment**: Each player in the reference database can have a primary team assigned.

2. **Subbing Detection**: During data processing (`stats_db_processor.py`), the system compares:
   - The player's primary team in the reference database
   - The team they're playing for in the current match

3. **Interactive Confirmation**: If these teams don't match, the system suggests the player is subbing, but allows you to confirm or reject this suggestion:
   ```
   Player 'PlayerName' (Primary Team: TeamA) is playing for 'TeamB'.
   Team names DON'T match.
   Suggest player IS subbing: Yes. Confirm? (Y/n):
   ```

4. **Permanent Storage**: Once confirmed, the subbing status (is_subbing flag) is stored permanently in the database for that player's match stats.

### Important Note: Player Transfers

If a player changes teams permanently:

1. Update their primary team in the reference database using the reference manager.
2. For historical matches, manually confirm/reject the subbing status during import to reflect the historical reality.

The crucial detail is that **subbing status is determined and fixed during import**, not dynamically recalculated. The reference database only provides suggestions during import.

### How Stats Reports Handle Subbing

Several reports utilize the subbing information differently:

- `player_performance.json`: Includes ALL appearances regardless of subbing status
- `player_performance_no_subs.json`: Only includes games where is_subbing = 0 (regular team appearances)
- `subbing_report.json`: Only includes games where is_subbing = 1 (substitute appearances)
- `player_teams.json`: Shows both regular and subbing appearances for each team

## Example Complete Workflow

1. Set up a reference database (one-time setup):
   ```bash
   python -m stats_reader reference
   ```

2. Extract match data from screenshots:
   ```bash
   python -m score_extractor.season_processor
   ```

3. Clean the extracted data:
   ```bash
   python -m stats_reader clean --input Screenshots/all_seasons_data.json --output Screenshots/all_seasons_data_cleaned.json
   ```

4. Process the cleaned data using the reference database:
   ```bash
   python -m stats_reader process --input Screenshots/all_seasons_data_cleaned.json --reference-db squadrons_reference.db
   ```

5. Generate an ELO ladder:
   ```bash
   python -m stats_reader elo
   ```

6. View the generated reports in the `stats_reports` directory